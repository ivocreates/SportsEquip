{% extends "base.html" %}

{% block title %}Edit Product - Admin - SpEquip{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col">
            <h1 class="text-primary mb-4">
                <i class="fas fa-edit me-2"></i>Edit Product: {{ product.name }}
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.admin_dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('main.admin_products') }}">Products</a></li>
                    <li class="breadcrumb-item active">Edit Product</li>
                </ol>
            </nav>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Product Information</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="product-form" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.name.label(class="form-label") }}
                                    {{ form.name(class="form-control") }}
                                    {% if form.name.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.name.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.category.label(class="form-label") }}
                                    {{ form.category(class="form-select") }}
                                    {% if form.category.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.category.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", rows="4") }}
                            {% if form.description.errors %}
                                <div class="text-danger small">
                                    {% for error in form.description.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.price.label(class="form-label") }}
                                    <div class="input-group">
                                        <span class="input-group-text">â‚¹</span>
                                        {{ form.price(class="form-control", step="0.01") }}
                                    </div>
                                    {% if form.price.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.price.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.stock_quantity.label(class="form-label") }}
                                    {{ form.stock_quantity(class="form-control") }}
                                    {% if form.stock_quantity.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.stock_quantity.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Image Upload Section -->
                        <div class="mb-3">
                            <label class="form-label">Product Image</label>
                            <div class="card">
                                <div class="card-body">
                                    <!-- Image Upload Options -->
                                    <div class="mb-3">
                                        <div class="btn-group" role="group" aria-label="Image upload options">
                                            <input type="radio" class="btn-check" name="image_option" id="url_option" autocomplete="off" checked>
                                            <label class="btn btn-outline-primary" for="url_option">
                                                <i class="fas fa-link me-1"></i>Online URL
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="image_option" id="upload_option" autocomplete="off">
                                            <label class="btn btn-outline-primary" for="upload_option">
                                                <i class="fas fa-upload me-1"></i>Upload File
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- URL Input -->
                                    <div id="url_input" class="mb-3">
                                        {{ form.image_url.label(class="form-label") }}
                                        {{ form.image_url(class="form-control", placeholder="https://example.com/image.jpg") }}
                                        <div class="form-text">Enter a direct link to the image (recommended: 500x500px, JPG/PNG)</div>
                                        {% if form.image_url.errors %}
                                            <div class="text-danger small">
                                                {% for error in form.image_url.errors %}
                                                    <div>{{ error }}</div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- File Upload -->
                                    <div id="file_input" class="mb-3" style="display: none;">
                                        <label for="image_file" class="form-label">Upload Image File</label>
                                        <input type="file" class="form-control" id="image_file" name="image_file" accept="image/*">
                                        <div class="form-text">Upload an image file (JPG, PNG, GIF) - Max size: 5MB</div>
                                    </div>
                                    
                                    <!-- Current Image Preview -->
                                    <div class="mb-3">
                                        <label class="form-label">Current Image</label>
                                        <div class="d-flex align-items-center">
                                            <img id="current_image" 
                                                 src="{{ product.image_url if product.image_url != 'default-product.jpg' else url_for('static', filename='images/default-product.jpg') }}" 
                                                 alt="{{ product.name }}" 
                                                 class="img-thumbnail me-3" 
                                                 style="max-width: 120px; max-height: 120px;">
                                            <div>
                                                <p class="mb-1"><strong>Current URL:</strong></p>
                                                <code class="small">{{ product.image_url }}</code>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Image Preview -->
                                    <div id="image_preview" class="mb-3" style="display: none;">
                                        <label class="form-label">Preview</label>
                                        <div>
                                            <img id="preview_image" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-save me-1"></i>Update Product
                                </button>
                                <a href="{{ url_for('main.admin_products') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </a>
                            </div>
                            <div>
                                <a href="{{ url_for('main.admin_delete_product', id=product.id) }}" 
                                   class="btn btn-outline-danger"
                                   onclick="return confirm('Are you sure you want to delete this product? This action cannot be undone.')">
                                    <i class="fas fa-trash me-1"></i>Delete Product
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Product Details Sidebar -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">Product Details</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Product ID</small>
                        <div><strong>#{{ product.id }}</strong></div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Created</small>
                        <div>{{ product.created_at.strftime('%B %d, %Y') }}</div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Category</small>
                        <div>
                            <span class="badge bg-secondary">{{ product.category.title() }}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Current Price</small>
                        <div><strong>â‚¹{{ "%.2f"|format(product.price) }}</strong></div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Stock</small>
                        <div>
                            {% if product.stock_quantity > 10 %}
                                <span class="badge bg-success">{{ product.stock_quantity }} in stock</span>
                            {% elif product.stock_quantity > 0 %}
                                <span class="badge bg-warning">{{ product.stock_quantity }} left</span>
                            {% else %}
                                <span class="badge bg-danger">Out of stock</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Actions</small>
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('main.product_detail', id=product.id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye me-1"></i>View Product Page
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Links -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">Quick Links</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.admin_products') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Back to Products
                        </a>
                        <a href="{{ url_for('main.admin_add_product') }}" class="btn btn-outline-success btn-sm">
                            <i class="fas fa-plus me-1"></i>Add New Product
                        </a>
                        <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-outline-info btn-sm">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlOption = document.getElementById('url_option');
    const uploadOption = document.getElementById('upload_option');
    const urlInput = document.getElementById('url_input');
    const fileInput = document.getElementById('file_input');
    const imageUrlField = document.getElementById('image_url');
    const imageFileField = document.getElementById('image_file');
    const previewDiv = document.getElementById('image_preview');
    const previewImage = document.getElementById('preview_image');
    
    // Toggle between URL and file upload
    urlOption.addEventListener('change', function() {
        if (this.checked) {
            urlInput.style.display = 'block';
            fileInput.style.display = 'none';
            imageFileField.value = '';
            previewDiv.style.display = 'none';
        }
    });
    
    uploadOption.addEventListener('change', function() {
        if (this.checked) {
            urlInput.style.display = 'none';
            fileInput.style.display = 'block';
            imageUrlField.value = '';
        }
    });
    
    // Image URL preview
    imageUrlField.addEventListener('input', function() {
        if (this.value && urlOption.checked) {
            previewImage.src = this.value;
            previewDiv.style.display = 'block';
            
            previewImage.onerror = function() {
                previewDiv.style.display = 'none';
            };
        } else {
            previewDiv.style.display = 'none';
        }
    });
    
    // File upload preview
    imageFileField.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewDiv.style.display = 'block';
            };
            reader.readAsDataURL(this.files[0]);
        } else {
            previewDiv.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
